import * as GAME from './game.js';
import * as GA from './AI-for-Snake-Game/geneticAlgorithm.js';

import * as CHARTS from './charts.js'

import * as POPS from './populations.js'

import SnakeGame from './AI-for-Snake-Game/snakeGame.js';
import SnakeGameGATest from './AI-for-Snake-Game/snakeGameGATest.js';
import SnakeGameGATrain from './AI-for-Snake-Game/snakeGameGATrain.js';

// https://stackoverflow.com/questions/23593052/format-javascript-date-as-yyyy-mm-dd
const timeOffset = new Date().getTimezoneOffset();
const date = new Date(new Date().getTime() - (timeOffset*60*1000));
// 2011-10-05T14:48:00.000Z
const fileLabel = date.toISOString().replaceAll('-','').replaceAll(':','').replace('T','_').split('.')[0];

// 4140 cpg200 bpw8 i9 h10 o4 (4152:)
let chromosome = '1010111101011100001000000011001100111001010101100001000010101001010011010010101000110001101101111111001101101100101010011101110110110110101100001011100100011111010000110001011111100100101111101000001011010010000000011000011110000101001101010000110100000010010001110011001000100101001100000100111000101100001001111101010110000001001001010011000101001000011001010100011001110000010000100111001111001110011100011111100110000100000000001000101110110010011011000101100010000101101010101010001001000000111000010011111010010101111101100110100000000001011110101100011111100101001001000011111010111001000001011101000010101000101000011000011010101100000001010110000000011100110011000000001101001011000111110001100010001100111101100001110111000101111001110100101111001101001001011111111000100100011111110101111111010010100101100100000010001000101110101101101101000100000011110010110101100010000001010010110001001100010010000100110111100001101000110001010110111100001000100100011110111010001011001010100011101001000111000100011101110011111111000001001110000001101001111011110010001010000011001101011110011010111011100110000011011100000111101000010101011110000100111001001000101101011110001010000001110100011000000001010101000100110111010001100111011101000111010101111010011111101010000010111010001011011010001101011111111111011001110111110011010001000111001110100110110111000101100110110010111000111110111111111010000010110101110001011001001001000001011101001111011010111010011101111101110000000101001011011100101110100110010100001101000000011110100010000011010000001101111010110000111100111101011011001110010011101111100100011111110000110010111101100000111100001010010011010000010110101101001010111110001110011000001100111001010100100110010001011101001111111011101110011011011101000100111000010011100001001010011110000101110001110001011000000100111100110000000111111010000000110100010100011001100011001001001110010110010111000001000111100101111011011100110010110101011101010001000100110000110000111011101001101110110011111010101000001111000110';
// let chromosome = '1010101101011101001000010110101100111001010101100011000010101001010011010010111001110001101111111111001111101100101010011101110110110110101100001011100100011111010100110001011111100100101111101000101011010010000000011000011110000101001101011001110100000010010001110011001000100101001100000101111000101100001011111101010110000001001001010011000101001000011001010100011001111000010000100111001101001110011100011111100110001100000000001000101110110010011011000101100010000100101010101010001001000000111000010011111010010101111101110110100000000001011110101110110111100111001001000011110010111001000000011101011110101000101100111000010011010100010111110110010101001000010011010001100111001001011101110101100010000110101111000001110111000010111000110100110111011100000000011111111000110100011111110100011101000010100101100110100010000001100101101100100101000110000001110010110101100010000000110011110000001101110010000101110111110001101001010001010010100101111000000100011010111010010111001110100111101001000101000100111001100011110111010000000110000011101001111011010010001010000111001101011010111010111000000110000011011010001111101000111101111111001111011100011100101000010110001010100001111000011000000001010101000100110111010001100111011101000111010101111010011110101010000010111010001011011010001101111111111111011001110111010011010001010111001010100110101110100000110110010110111000101111111011101010000000110101110001011001101001000001011101001111011010111011011101111101110000000101001011010100101100100010010101111101001110011111100010000011010000001101111010110000111100111101011011011110110011100011100110011111110001110010110101100000011100001010001011010000010110001101001010111010001110011000001100111001000100100100110101010101001111111011101111010011111101000001111000010011100101001010011110000101111000110001011010000100011000110100100111110010000000110100010100011000110011000011001111000110010111000101100111100111101111011110110010110101111111000001000101110000110000111001111001101110110011111110101011111111000110';
// let chromosome = '1010001111011000001000000010101100111001010101100001000010111001010011010010101001110001101111111111001111101100101010011101010110110110101100001011101100011111010000110001110111100100101111101000001011010010000000011000011110000101001001011000110100000000010001110011001001100101001100000100111000101100001001111101010010010001001001010011001101001000111001010100001001101000010000100111001101101010011100011111100110001100000000001000001110110010011011000111000010000110101110101010001001000010111000010011111010010101111101110111000000000001011110101100011111100111001001010011111010111101000001011101001010101000101100011000011010111101000001010110000011001100010011010001100110000001011111100001100010000110100101000001111111000110111000110100101111011110000000001111111100110100011111110100111101000010100101100100100010001001000100101101100100110110001011111010100101100010000001010011110000001000100010000101110111010001101001010001010010101100011000000100011010011010001011001010111011101000000111000100011101110011111110000001000110000011101101111011110010001011000011001101011110011010111010110110000011010000000111101000011101011110000100111001001000101101011110001110101001010000011000000001010111000110110111010001000111111101000111010111111010011110101010000010111110001000011010001101111111111111011001100111010111010101000111001110100110110111000101100110010010111000101110101011111010000010100101110001111001011001000001011101001111011000111011011101111101110000000101001001011100101100101110010100111101000110011110101010000011010000001101111000110000111000111001011001001110010001000111100110011111110000110010110111100000111100000010000001010000000110101101001010111110001110011000001100111001010100100100110101011001001011111111101110011011011001000001101000010011100001001010011100010101110000111001111000000100111101010000000111111010000001110100010100011001100011001001001110010110010101000001000111100101101111011101110010100101111111000001010100110000110000111001101001100110110011111010101001111111000110';
// let chromosome = '1010011001011101001000000010001100101001010101101001000010101011010011000110101001110001111111111110001111001100101010011101010100110111101000001011100110011111010000110001010111100100101111001000101011010010000000011001111110000101000101011001110100001010001001110011111001100101001100000100101000100100001001011101010110000001001001010011000101001000111001010101001001111000010000100111000101101110011100011111100110001100000000001000101110110010011011000101100010000100101010101010001001000000111000010011111010010101111101100110100000001001011110101101011111100101001001000011111010111101000001011101000010101000101100011000011010111101000001010110000000001100010011000000001001100011000111110001100010001100110101100001110111000101111011110100101111001101001001011111111000100100011111110101111011010010100101100100000010000000101111101100101101000100000011110010110101100010000001010011010000001100110110000101110111110001101001010001010010101000111000000100011010011010010111001010100111101001000101000100110101100011110111010000100110000011101001111011010010001110000111001101011010111010111000000000000011011010000111101000111101111111001111011000001100101001010110101010100001111000010000000001000101000100110101011001000111011101000111000101111010010110101010000000111010001110011000101101111111110111011001100111110111010001000011001110100110111110000000100110010010111110101110101011101010000010110101111001101001101001000101111100001001111010111011101101011101110000100001101011011100111100100111000100101101010101111110000010000011100000001101111000011000110000111110001010001110011101000001100111011111110000110000100111111000001100011000001010010000000110101101001010111110001110011000001100111001010100100100110101011001001011111111101110011011011001000001101000010011100001001010011100010101110000111001111000000100111101010000000111111010000001110100010100011001100011001001001110010110010101000001000111100101101111011101110010100101111111000001010100110000110000111001101001100110110011111010101001111111000110';
// let chromosome = '1010011101011100001100000010101100111001010101100001000010100001010011010010101001110001101111111111001111101100101010011101110110110110101100001011100100011111010100110001010111100100101111101000001011010010000000011000011110000101001101011001110100000010010001110011001000100101001100000101111000101100001011111101010110000001001001010011000101001000011001010100011001111000010000000111001101001110011100011111100110001100000000001000101110110010011011000101100010000100101010101010001001000000111000010011111010010101111101110110100000000001011110101110110111100111001001000011110010111001000000011101011110101000101100111000010011010100010111110110010101001000010011010001100111001011011101110101100010000110101111000001110111000010111000110100110111011100000000011111111000110100011111110100011101000010100101100100100010000001100101101100100101000110000001110010110101000010000000110011110000001101110010000101110111110001101001010001010010100101111000000100011010111010010111001110100111101001000101000100111001100011110111010000000110000011101001111011010010001010000111001101011010111010111000000110100011011010001111111000111101111111001111011100011100101000010110001010100001111000011000000001010101000100110111010001100111011101000111010101111010011110101010000010111010001011011010001101111111111111011001110111010011010001010111001010101110101110100000110010010110111000101111111011101010000000110101110001011001101001000001011101001111011010111011011101111101110000000101001001010100101100100010010101111101001110011111100010000011010000001101111010110000111100111101011011011110110011100011100110011111110001110010110101100000011100001110001011010000010110001101001010111010001100011000001100111001000100100100110101010001001111111011101111010011111101000001111000110011100101001010011110000101111000110001011010100100011000110100100111110010000000110100010100011000110011000011001111000110010111000101100111100111101111011110110010110101011111000001000101110000110000111001111001101110110011111110101011111111000110';
// let chromosome = '1010101101011101001000010110101100111000010101100011000010101001010011010010111000110001101111111111001111101100101010011101110110110110101100001011100100011111010100110001011111100100101111101000101011010010000000011000011110000101001101011001110100000010010001110011001000100101001100000101111000101100001011111101010110000001001001010011000101001000011001010100011001111000010000100111001101001110011100011111100110001100000000001000101110110010011011000101100010000100101010101010001001000000111000010011111010010101111101110110100000000001011110101110110111100111001001000011110010111001000000011101011110101000101100111000010011010100000111110110010101001000010011110001100111001001011101110101100010000110100111000001110111000010111000110100110111011100000000011111111000110100011111110100011101000010100101100110100010000001100101101100100101000110000001110010110101100010000000110011110000001101110010000101110111110001101001010001010010100101111000000100011010111010010111001110100111101001000101000100111001100011110111010000000110000011100101111011010010001010000111001111011010111010111100100100000011011010001111101000111101111111001111011100011100101000010110001010100001111000011000000101010101000100110111010001100111011101000111010101111010011110101010000010111010001011011010001101111111111110011001110111010011010001010111001010100110101110100000110110010110111000101111111011101010000000110101110001011001101001000001011101001111011010111011011101111101110000000101001011010100101100100010010101011101001110011111100010000011010000001101111010110000111100111101011011011110110011110011100100011111110000110010110101100000111100001010010011010000000110101101001010111110001110011000101100111001010100000110010101011101001111111011101110011011011101000100111000010011100001001010011110000101110001111001011000000100111100110100000111111010000000110100000100011001101001001001001110010110010111000001000111100101111011011100110010110101111110000101010110110100010100111011101000100010110011111000001101111111000110';
// 2200 cpg400 bpw8 i9 h20 o4
// let chromosome = '0100011101010000000001010101011100100000101001111010100001010100100010001101101001011110001101000011001111010111101001000011111001010010100110100000000011010010000011001111101110011101010110111011010000001001110010101001000110000111010001111011000111010111100001000000000001011111000111011111001110101100100010111100010111000000001110100000111100000010000001001100001001000011000001110010001110100010011001101110111000010000101001011011000001000001000011111011001001111000001000111101100000001111110100000000110101111101000111001110000000011110001000100100000010000100000010101100000010100111110001100111110011001001000000001000011101100110000101010000000001011101010111100100100010010101111000000100111000011100011001101001010110110010101100001111101001100001101100110101001011010001110111100111000100010110011001011010010100100100100001000111011001000000101001100111001101010000111111010010101101001100011011000001000010110000011000111111111110001101010011111100010001100011110110100101110010100100100001110010001111001000110110010011100001000000101010110011110011011000111101010101010000010100110000011101100011111001111011111110000000100011101011110001100010111111000111110000010111011000111101011000101100100110111011101101101010101111100010110101110010101100110011101001101011111110101011101111010001111111010001100101110011011011001110111101101000100011001001101111111111000001110000010100000101111011101101100011100011111111001110010101011000100011101111111101101110110111100101010001101000110000100011101011001010000001001000011000111010111111111010010110100001010110110110000101111111110110010001111001011101101010101011101111110011111110111101000010000010001010100101000101111101111111001000110000010000111000001010000010001101010110111011001011011000100011110011010101010100010011000110000001001011101111100001101001000110001111100011101010110111000111010100001101110001011010101001000110110101100101001100101110100001001111001001100110110010001011001100100111110000000000011101101111011111110111001010110010010101110111001110010011001010010100101001100100101011010100001111011110001111011011000010011011101100101101001110001011100010110101110000011101110011001011011110111111011100101001000100011100001010011010001000000001110000110101100100001011111001110010101100000001000110100111111111001010000110101101101011000100100011101111010011010000011010100110111100010001111110101010100110101001110100011101000101110100100110101001101110101010110011001011001110000110111001101100101011100110110011101110101000111010001110101010001011110111001110100000000001000101110010111111011111101000011011001111110010000011100001010100010011110011011001010101101111110101111011001001000101001101101010110101100001011001000110101011010101001111000000010101101110001111011101111001111010010000011100000000110100010000001101110000111100111010101001100101101100000010010000111011001010110001000110111011111001001011111010111001111010110110101010101100101000100111001001001000000011110100110101111000101110011110000101111010111110101010101000100111011011000110010011010011110011010010011100100001100010101100100010100010101111001010110111101011101011010110011000011111010000010100000111001101010010000101110001110100000110001001111011001011100100011100001010100010000000110101011010011110110111010001110110110111111011011100010010011001001000000010010011100011000011011001111110110101111100110111001010010111100011110001100110101100100001111110101010111100000010100000111011010101110110011100000000100011000101000011101010001000101011000010001001001001010111110010100101101101000100101101111010010010100001011111010010000101110011011010010000000101011111111011001100000101100011101000101001001000110001101000001111010001100010100110001110101111101100100011101010100010000100000010101100001101010000111101010000011001001110011000001101100010000010100000000011100010101010101110100100100100100101001100100000100000111110111110111101101111011100000110110101011001111110000110101011001011101100000011011110100110010100010011011000000110010001011001001000110001110110111110111101111001101110100001000001001110101011001110111110110010101100110111111100111000101000101000111001101011010100000011110001111011110011110111010011111100010011100001010011101110110011010010010101110100100111101110000010111011111000110001100110111011001011001011000111111111101100010011111101011111011000000011110010001110100011000100101000111110010011111000100111110100100001100101010110001101101000000101011011110011000010111100011111111100110001001110100010101001000101111101100010000111101001101010100011000000001000110001001110100111011000011101110011100100110001111111011000100111001111000011011110111000101001000000100110111111001001110001010001011011010100001001110001110100000010101001111011010010011001101011100101100011100101100110000000101011110100100010010111110111100111001101111011110001000110100011000100100010000110111001001110000111000010011000000110100110011111011101101110111011001010101000010011000010111111000000011011101010100010111001011100101010101011000111100010000000001111001001011010111011010110000110100010100011101101101110000001101000000101011111001101100011010111000100010111101110110100100101000011000001100101101010100000000101110111001010100000010010011110110010001001010011111000000111100010100100101100000100001100101111100101011110011110000000010000010010001100011110110001101011010010010010010101011110101001110010010000110110001010110011111010011010100110101110111001100001011000101101111111101011000011000011100001111001010100111110101111110001010111001101100000000101110101110010000010100001000111101010110111100100011001010001';

let bits_per_weight = 8;

let num_inputs = 9;
let num_hiddens = 10;
let num_outputs = 4;

let chroms_per_gen = 200;
let total_bits = ((num_inputs + 1) * num_hiddens + num_hiddens * (num_hiddens + 1) + num_outputs * (num_hiddens + 1)) * bits_per_weight;
//let population = POPS.population_20220723_085133_gen_2200;
let population = GA.genPopulation(chroms_per_gen, total_bits);

const snakeGame = new SnakeGame(500);
let snakeGameGATest = new SnakeGameGATest(25, chromosome, bits_per_weight, num_inputs, num_hiddens, num_outputs);
let snakeGameGATrain = new SnakeGameGATrain(0, population, chroms_per_gen, bits_per_weight, num_inputs, num_hiddens, num_outputs);

window.snakeGame = snakeGame;
window.snakeGameGATest = snakeGameGATest;
window.snakeGameGATrain = snakeGameGATrain;
window.CHARTS = CHARTS;

let isTraining = false;
let isTesting = false;
let isPlaying = false;

GAME.state.onPhaseChange.push( function(phase) {
    switch (phase) {
        case GAME.PHASES.INIT:
            console.log("init");
            break;
        case GAME.PHASES.LOAD_STARTED:
            console.log("load started");
            break;
        case GAME.PHASES.LOAD_COMPLETED:
            console.log("load completed");

            switchTab(false, true, false);
            $("#testChromosome").val(chromosome);
            $("#testChromosome").change( function () {
                if ($(this).val().length == total_bits) {
                    GAME.managers.releaseAllInstances();

                    snakeGameGATest = new SnakeGameGATest(25, $(this).val(), bits_per_weight, num_inputs, num_hiddens, num_outputs);
                
                    $("#testChromosomeInfo").css("color", "#008800");
                    $("#testChromosomeInfo").html("Accepted")
                } else {
                    $("#testChromosomeInfo").css("color", "#880000");
                    $("#testChromosomeInfo").html("Denied")
                }
            })

            GAME.state.phase = GAME.PHASES.GAME_STARTED;
            break;
        case GAME.PHASES.GAME_STARTED:
            break;
        case GAME.PHASES.GAME_PAUSED:
            break;
        case GAME.PHASES.GAME_RESUMED:
            break;
    }
});

const keys = []

let max_1 = -Infinity;
let max_2 = -Infinity;
let max_score = -Infinity;
let max_frame_score = -Infinity;
function onGameOver(num_generations, cur_chrom, score, frames_alive, fitness) {
    let cur_gen = snakeGameGATrain.num_generations;

    CHARTS.data1.push({ x: cur_chrom, score: score, frame_score: fitness.frame_score });
    CHARTS.cfg1.data.labels.push(cur_chrom);
    
    CHARTS.data3.push({ x: cur_chrom, _1: fitness._1, _2: fitness._2 });
    CHARTS.cfg3.data.labels.push(cur_chrom);

    //console.log(fitness._3);
    CHARTS.data4.push({ x: cur_chrom, _3: fitness._3 });
    CHARTS.cfg4.data.labels.push(cur_chrom);

    // CHART 10
    if (fitness._3 > 0) {
        CHARTS.cfg10.data.datasets[cur_gen].data.push({ x: fitness._1, y: fitness._2 });

        if (max_1 < fitness._1) { 
            max_1 = fitness._1; 
            CHARTS.cfg10.options.scales.x.max = 1.3 * max_1;
        }
        if (max_2 < fitness._2) { 
            max_2 = fitness._2;
            CHARTS.cfg10.options.scales.y.max = 1.3 * max_2;
            CHARTS.cfg10.options.scales.y.ticks.stepSize = Math.round((max_2 / 40) / 10) * 10;
        }

        CHARTS.chart10.update();
    }

    // CHART 11
    if (fitness._3 > 0) {
        CHARTS.cfg11.data.datasets[cur_gen].data.push({ x: score, y: fitness.frame_score });

        if (max_score < score) { 
            max_score = score; 
            CHARTS.cfg11.options.scales.x.max = 1.3 * max_score;
        }
        if (max_frame_score < fitness.frame_score) { 
            max_frame_score = fitness.frame_score;
            CHARTS.cfg11.options.scales.y.max = 1.3 * max_frame_score;
            CHARTS.cfg11.options.scales.y.ticks.stepSize = Math.round((max_frame_score / 40) / 10) * 10;
        }

        CHARTS.chart11.update();
    }

    CHARTS.chart1.update();
    CHARTS.chart3.update();
    CHARTS.chart4.update();

    $("#generation").html(`GENERATION: ${cur_gen}`);
    $("#chromosome").html(`CHROM: ${snakeGameGATrain.cur_chrom} / ${chroms_per_gen}`);
    $("#score").html(`SCORE: ${snakeGameGATrain.score}`);
    $("#high_score").html(`HIGHSCORE: ${snakeGameGATrain.high_score}`);
}

const palettes = [
    '#f3a935', '#c73558', '#6ebe9f', '#2586a4', '#55596a', // https://www.color-hex.com/color-palette/32566
    '#fe0000', '#fdfe02', '#0bff01', '#011efe', '#fe00f6', // https://www.color-hex.com/color-palette/1131
    '#feda75', '#fa7e1e', '#d62976', '#962fbf', '#4f5bd5', // https://www.color-hex.com/color-palette/44340
]
palettes.counter = 0;

const BestParents = {
    longest: 0,
    update(bps) {
        for (let i = 0; i < bps.length; i++) { 
            let chromosome = bps[i].chromosome;
            let fitness = bps[i].fitness;
            let generationNum = snakeGameGATrain.num_generations - 1;
    
            if (!this[chromosome]) { this[chromosome] = [] }
            this[chromosome].push({ gen: generationNum, fitness: fitness});

            if (this[chromosome].length > this.longest) { this.longest = this[chromosome].length; }
        }
    }
};
let bestParents = Object.create(BestParents);

window.bestParents = bestParents;

function onGenerationOver(average_game_score, average_frame_score, average_fitness, best_individual, fitnessRatios, fitnessRouletteCutoffs, bps) {
    let cur_gen = snakeGameGATrain.num_generations;
    
    CHARTS.data1.length = 0
    CHARTS.cfg1.data.labels.length = 0
    CHARTS.data3.length = 0
    CHARTS.cfg3.data.labels.length = 0
    CHARTS.data4.length = 0
    CHARTS.cfg4.data.labels.length = 0

    CHARTS.data5.length = 0
    CHARTS.cfg5.data.labels.length = 0
    CHARTS.data6.length = 0
    CHARTS.cfg6.data.labels.length = 0

    CHARTS.cfg8.data.labels.length = 0
    CHARTS.cfg8.data.datasets.length = 0
    CHARTS.cfg9.data.labels.length = 0
    CHARTS.cfg9.data.datasets.length = 0

    for (let i = 0; i < fitnessRatios.length; i++) {
        CHARTS.data5.push({ x: i, ratio: fitnessRatios[i] });
        CHARTS.cfg5.data.labels.push(i);
    }
    for (let i = 0; i < fitnessRouletteCutoffs.length; i++) {
        CHARTS.data6.push({ x: i, cutoff: fitnessRouletteCutoffs[i] });
        CHARTS.cfg6.data.labels.push(i);
    }

    CHARTS.data2.push({ x: cur_gen - 1, average_game_score: average_game_score, average_frame_score: average_frame_score });
    CHARTS.cfg2.data.labels.push(cur_gen - 1);
    
    CHARTS.data7.push({ x: cur_gen - 1, average_fitness: average_fitness });
    CHARTS.cfg7.data.labels.push(cur_gen - 1);

    bestParents.update(bps);
    // CHART 8
    let forDownload = [];
    let entries = Object.entries(bestParents)
        .filter((a) => a[1][0])                                   // keeping only those with array as a value
        .filter((a) => a[1][a[1].length - 1].gen == cur_gen - 1); // keeping only lasted until this generation
    // entry[0] - key (chromosome); entry[1] - value ({gen: N, fitness: S});
    entries.sort((a, b) => {
        const avgA = a[1].map((element, index, array) => element.fitness).reduce((sum, a) => sum + a, 0) / a[1].length;
        const avgB = b[1].map((element, index, array) => element.fitness).reduce((sum, a) => sum + a, 0) / b[1].length;
        
        // https://stackoverflow.com/questions/10759018/how-can-i-reliably-subsort-arrays-using-dom-methods
        return (b[1].length - a[1].length) || (avgB - avgA);
    });   // sorting descending by the number of generations and by the average fitness
    
    let bottom = Math.floor(cur_gen - bestParents.longest * 1.1);
    let top = Math.ceil(cur_gen + bestParents.longest * 0.1);
    for (let i = bottom; i < top; i++) { CHARTS.cfg8.data.labels.push(i); }

    let range = entries.length < 5 ? entries.length : 5; // taking top-5 results of sort
    for (let i = 0; i < range; i++) { // taking top-5 results of sort
        let chromosome = entries[i][0];
        let infos = entries[i][1];

        forDownload.push({ chromosome, infos });

        let dataset = {
            label: chromosome.substring(0,8),
            data: [],
            borderColor: palettes[palettes.counter % palettes.length],
            backgroundColor: palettes[palettes.counter++ % palettes.length],
            yAxisID: 'y',
        }
        for (const info of infos) { dataset.data.push({ x: info.gen, y: info.fitness }); }
        CHARTS.cfg8.data.datasets.push(dataset);
    }

    // https://www.codegrepper.com/code-examples/javascript/save+array+file
    let a = document.getElementById("downloadBestParents1").appendChild(document.createElement("a"));
    a.download = `best_parents_top5_1_${fileLabel}_gen_${cur_gen}.txt`;
    a.href = "data:text/plain;base64," + btoa(JSON.stringify(forDownload));
    a.innerHTML = `${cur_gen}`;
    let span = document.getElementById("downloadBestParents1").appendChild(document.createElement("span"));
    span.innerHTML = " • ";

    // CHART 9
    forDownload = [];
    entries = Object.entries(bestParents)
        .filter((a) => a[1][0])                                     // keeping only those with array as a value
        .filter((a) => a[1][a[1].length - 1].gen == cur_gen - 1)    // keeping only lasted until this generation
        .filter((a) => a[1].length >= bestParents.longest * (1/3)); // keeping those lasted at least 1/3 of the longest living
    // entry[0] - key (chromosome); entry[1] - value ({gen: N, fitness: S});
    entries.sort((a, b) => { // sorting descending by fitness averages
        const avgA = a[1].map((element, index, array) => element.fitness).reduce((sum, a) => sum + a, 0) / a[1].length;
        const avgB = b[1].map((element, index, array) => element.fitness).reduce((sum, a) => sum + a, 0) / b[1].length;
        
        return avgB - avgA;
    }); 
    
    bottom = Math.floor(cur_gen - bestParents.longest * 1.1);
    top = Math.ceil(cur_gen + bestParents.longest * 0.1);
    for (let i = bottom; i < top; i++) { CHARTS.cfg9.data.labels.push(i); }
    
    range = entries.length < 5 ? entries.length : 5; // taking top-5 results of sort
    for (let i = 0; i < range; i++) { 
        let chromosome = entries[i][0];
        let infos = entries[i][1];

        forDownload.push({ chromosome, infos });

        let dataset = {
            label: chromosome.substring(0,8),
            data: [],
            borderColor: palettes[palettes.counter % palettes.length],
            backgroundColor: palettes[palettes.counter++ % palettes.length],
            yAxisID: 'y',
        }
        for (const info of infos) { dataset.data.push({ x: info.gen, y: info.fitness }); }
        CHARTS.cfg9.data.datasets.push(dataset);
    }

    // https://www.codegrepper.com/code-examples/javascript/save+array+file
    a = document.getElementById("downloadBestParents2").appendChild(document.createElement("a"));
    a.download = `best_parents_top5_2_${fileLabel}_gen_${cur_gen}.txt`;
    a.href = "data:text/plain;base64," + btoa(JSON.stringify(forDownload));
    a.innerHTML = `${cur_gen}`;
    span = document.getElementById("downloadBestParents2").appendChild(document.createElement("span"));
    span.innerHTML = " • ";

    // CHART 10
    CHARTS.cfg10.data.datasets.push({ 
        label: `${cur_gen}`, 
        data: [], 
        backgroundColor: palettes[palettes.counter % palettes.length] 
    });

    // CHART 11
    CHARTS.cfg11.data.datasets.push({ 
        label: `${cur_gen}`, 
        data: [], 
        backgroundColor: palettes[palettes.counter++ % palettes.length] 
    });

    CHARTS.chart5.update();
    CHARTS.chart6.update();
    CHARTS.chart2.update();
    CHARTS.chart7.update();
    CHARTS.chart8.update();
    CHARTS.chart9.update();

    document.getElementById("bestIndividual").textContent = best_individual;

    // https://www.codegrepper.com/code-examples/javascript/save+array+file
    a = document.getElementById("downloadPopulation").appendChild(document.createElement("a"));
    a.download = `population_${fileLabel}_gen_${cur_gen}.txt`;
    a.href = "data:text/plain;base64," + btoa(JSON.stringify(snakeGameGATrain.population));
    a.innerHTML = `${cur_gen}`;
    span = document.getElementById("downloadPopulation").appendChild(document.createElement("span"));
    span.innerHTML = " • ";

}

snakeGameGATrain.onGameOver = onGameOver;
snakeGameGATrain.onGenerationOver = onGenerationOver;

let trainingStarted = true;
let drawModels = true;

function train(redraw) {
    if (!trainingStarted || !isTraining) { return; }

    snakeGameGATrain.move_snake(keys);
    snakeGameGATrain.check_collisions();
    snakeGameGATrain.update_frames_since_last_fruit();
    snakeGameGATrain.frames_alive++;
    if (redraw) { snakeGameGATrain.draw_grid_updates(); }
}

GAME.callbacks.onUpdate = function(delta, elapsed) {
    
    if ( isPlaying && (snakeGame.elapsed == 0 || (elapsed - snakeGame.elapsed > snakeGame.delay)) ) {
        snakeGame.elapsed = elapsed

        snakeGame.move_snake(keys);
        snakeGame.check_collisions();
        snakeGame.draw_grid_updates();

        $("#generation").html(``);
        $("#chromosome").html(``);
        $("#score").html(`SCORE: ${snakeGame.score}`);
        $("#high_score").html(`HIGHSCORE: ${snakeGame.high_score}`);

        if (snakeGame.restart) {
            snakeGame.restart = false;
        }

        keys.length = 0;
    }
    
    if ( isTesting && (snakeGameGATest.elapsed == 0 || (elapsed - snakeGameGATest.elapsed > snakeGameGATest.delay)) ) {
        snakeGameGATest.elapsed = elapsed

        snakeGameGATest.move_snake(keys);
        snakeGameGATest.check_collisions();
        snakeGameGATest.update_frames_since_last_fruit();
        snakeGameGATest.draw_grid_updates();

        $("#generation").html(``);
        $("#chromosome").html(``);
        $("#score").html(`SCORE: ${snakeGameGATest.score}`);
        $("#high_score").html(`HIGHSCORE: ${snakeGameGATest.high_score}`);

        if (snakeGameGATest.restart) {
            snakeGameGATest.restart = false;
        }

    }
    
    if ( isTraining && drawModels && (snakeGameGATrain.elapsed == 0 || (elapsed - snakeGameGATrain.elapsed > snakeGameGATrain.delay)) ) {
        snakeGameGATrain.elapsed = elapsed

        train(true);
    }
}

GAME.callbacks.onKeyDown = function(event) {
    keys.push(event.code);
}

$("#startStopTraining").click(function () {
    trainingStarted = !trainingStarted;
    if (trainingStarted) {
        $(this).html("Training: OFF");
    } else {
        $(this).html("Training: ON");
    }
});

let intervalID = -1;
$("#startStopDrawing").click(function () {
    drawModels = !drawModels;
    if (drawModels) {
        $(this).html("Draw Models: OFF");

        if (intervalID != -1) {
            clearInterval(intervalID);
            intervalID = -1;
        }

    } else {
        $(this).html("Draw Models: ON");

        intervalID = setInterval(train, 0);
    }
});

$("#populationFileInput").on("change", function() {
    const reader = new FileReader();

    $(reader).on("load", (event) => {
        try {
            let temp = JSON.parse(event.target.result.replaceAll("'","\""));
            snakeGameGATrain = new SnakeGameGATrain(0, temp, chroms_per_gen, bits_per_weight, num_inputs, num_hiddens, num_outputs);
            snakeGameGATrain.onGameOver = onGameOver;
            snakeGameGATrain.onGenerationOver = onGenerationOver;

            bestParents = Object.create(BestParents);
            CHARTS.clearAll();
        } catch (e) {
            console.log(e);
        }
    });

    reader.readAsText($(this)[0].files[0]);

    $(this).val('');
});

$("#uploadPopulation").on("click", function() {
    $("#populationFileInput").trigger("click");
});

$("#trainButton").click(() => switchTab(true, false, false));
$("#testButton").click(() => switchTab(false, true, false));
$("#playButton").click(() => switchTab(false, false, true));

function switchTab(tr, te, pl) {
    $("#trainTab").hide();
    $("#testTab").hide();
    $("#playTab").hide();
    
    if (tr) {
        $("#trainTab").show();
    } else if (te) {
        $("#testTab").show();
    } else if (pl) {
        $("#playTab").show();
    }
    
    GAME.managers.releaseAllInstances();

    isTraining = tr;
    isTesting = te;
    isPlaying = pl;
}

GAME.state.phase = GAME.PHASES.INIT;